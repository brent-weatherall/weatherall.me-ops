name: Deploy Infrastructure
on:
  push:
    branches:
      - master
    paths:
      - 'infrastructure/**'
  workflow_dispatch:

env:
  # Secrets mapping for all jobs
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_ENDPOINT_URL_S3: ${{ secrets.R2_ENDPOINT_URL }}
  TF_VAR_virtual_environment_endpoint: ${{ secrets.PROXMOX_API_ENDPOINT }}
  TF_VAR_virtual_environment_api_token: ${{ secrets.PROXMOX_API_TOKEN }}

jobs:
  layer-1-cluster:
    name: 01 - Cluster Hardware
    runs-on: [self-hosted, oracle-cloud]
    defaults:
      run:
        working-directory: infrastructure/01-cluster
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"
      - run: terraform init
      - run: terraform apply -auto-approve -parallelism=2

  extract-keys:
    name: 01b - Extract Keys
    needs: layer-1-cluster
    runs-on: [self-hosted, oracle-cloud]
    defaults:
      run:
        working-directory: infrastructure/01-cluster
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"
      - run: terraform init
      - name: Save Keys
        run: |
          mkdir -p ~/.kube ~/.talos
          terraform output -raw kubeconfig > ~/.kube/config
          terraform output -raw talosconfig > ~/.talos/config
          chmod 600 ~/.kube/config ~/.talos/config
          
          TARGET_USER="bweatherall"
          if id "$TARGET_USER" &>/dev/null; then
            TARGET_HOME="/home/$TARGET_USER"
            sudo mkdir -p $TARGET_HOME/.kube $TARGET_HOME/.talos
            sudo cp ~/.kube/config $TARGET_HOME/.kube/config
            sudo cp ~/.talos/config $TARGET_HOME/.talos/config
            sudo chown -R $TARGET_USER:$TARGET_USER $TARGET_HOME/.kube $TARGET_HOME/.talos
            sudo chmod 600 $TARGET_HOME/.kube/config $TARGET_HOME/.talos/config
          fi

  layer-2-platform:
    name: 02 - Platform (Cilium)
    needs: extract-keys
    runs-on: [self-hosted, oracle-cloud]
    defaults:
      run:
        working-directory: infrastructure/02-platform
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"
      - run: terraform init
      - run: terraform apply -auto-approve

  configure-cilium:
    name: 03 - Configure Cilium
    needs: layer-2-platform
    runs-on: [self-hosted, oracle-cloud]
    steps:
      - uses: actions/checkout@v4
      - name: Apply L2 Config
        run: |
          export KUBECONFIG=~/.kube/config
          kubectl apply -f kubernetes/bootstrap/cilium-config.yaml