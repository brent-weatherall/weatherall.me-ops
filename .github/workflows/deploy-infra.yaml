name: Deploy Infrastructure
on:
  push:
    branches:
      - master
    paths:
      - 'infrastructure/terraform/**'
  workflow_dispatch:

jobs:
  terraform:
    name: Terraform Apply
    runs-on: [self-hosted, oracle-cloud]
    defaults:
      run:
        working-directory: infrastructure/terraform

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"

      - name: Terraform Init
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_ENDPOINT_URL_S3: ${{ secrets.R2_ENDPOINT_URL }}
        run: terraform init

      - name: Terraform Plan
        env:
          TF_VAR_virtual_environment_endpoint: ${{ secrets.PROXMOX_API_ENDPOINT }}
          TF_VAR_virtual_environment_api_token: ${{ secrets.PROXMOX_API_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_ENDPOINT_URL_S3: ${{ secrets.R2_ENDPOINT_URL }}
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        env:
          TF_VAR_virtual_environment_endpoint: ${{ secrets.PROXMOX_API_ENDPOINT }}
          TF_VAR_virtual_environment_api_token: ${{ secrets.PROXMOX_API_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_ENDPOINT_URL_S3: ${{ secrets.R2_ENDPOINT_URL }} 
        run: terraform apply -auto-approve -parallelism=2 tfplan

      - name: Extract & Save Cluster Keys
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_ENDPOINT_URL_S3: ${{ secrets.R2_ENDPOINT_URL }}
        run: |
          mkdir -p ~/.kube ~/.talos
          terraform output -raw kubeconfig > ~/.kube/config
          terraform output -raw talosconfig > ~/.talos/config
          chmod 600 ~/.kube/config ~/.talos/config
          
          TARGET_USER="bweatherall"
          if id "$TARGET_USER" &>/dev/null; then
            TARGET_HOME="/home/$TARGET_USER"
            sudo mkdir -p $TARGET_HOME/.kube $TARGET_HOME/.talos
            sudo cp ~/.kube/config $TARGET_HOME/.kube/config
            sudo cp ~/.talos/config $TARGET_HOME/.talos/config
            sudo chown -R $TARGET_USER:$TARGET_USER $TARGET_HOME/.kube $TARGET_HOME/.talos
            sudo chmod 600 $TARGET_HOME/.kube/config $TARGET_HOME/.talos/config
          fi

      - name: Apply Cilium Config (L2 Announcements)
        run: |
          export KUBECONFIG=~/.kube/config
          echo "Waiting for API..."
          # Simple retry loop
          for i in {1..30}; do kubectl get nodes && break || sleep 10; done
          
          echo "Applying Cilium IP Pool..."
          # Path relative to 'infrastructure/terraform' working dir
          kubectl apply -f ../../kubernetes/bootstrap/cilium-config.yaml